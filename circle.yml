machine:
  ruby:
    version: rbx-2.2.6
  services:
    - docker

dependencies:
  override:
    - sudo pip install --upgrade docker-compose==1.2.0
    - bundle install

test:
  override:
    - docker-compose -f docker-compose.yml run web /.composer/vendor/phpunit/phpunit/phpunit  /var/www/html/:
        timeout: 1200
    - rake spec:
        timeout: 1200
    # start apache in background
    - docker-compose -f docker-compose.yml up -d
    # ngrock /ghostinspector real request
    - unzip -d ~/ ~/$CIRCLE_PROJECT_REPONAME/ngrok_2.0.19_linux_amd64.zip
    - ~/ngrok authtoken $NGROK_TOKEN
    - ~/ngrok http -subdomain=$CIRCLE_SHA1 8888:
        background: true
    # Wait for application and ngrok to be ready
    - curl --retry 10 --retry-delay 10 -v https://$CIRCLE_SHA1.ngrok.io
    # Execute Ghost Inspector tests using the ngrok tunnel
    - curl "https://api.ghostinspector.com/v1/suites/$GHOST_SUITE_ID/execute/?apiKey=$GHOST_API_KEY&startUrl=https://$CIRCLE_SHA1.ngrok.io" > $CIRCLE_ARTIFACTS/ghostinspector.json
    - if [ $(grep -c '"passing":false' $CIRCLE_ARTIFACTS/ghostinspector.json) -ne 0 ]; then exit 1; fi

  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -name "results.xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

deployment:
  production:
    branch: [php55beta]
    commands:
      - ./deploy.sh

